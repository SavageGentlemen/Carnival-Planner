rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && request.auth.token.email == 'djkrss1@gmail.com';
    }
    
    // PromoAds - readable by all (including unauthenticated for display), writable only by admin
    match /promoAds/{adId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Support requests - writable by all authenticated users, readable by admin
    match /support-requests/{requestId} {
      allow create: if request.auth != null;
      allow read, update, delete: if isAdmin();
    }
    
    // User activity tracking - any authenticated user can create, admin can read all
    match /user-activity/{activityId} {
      allow create: if request.auth != null;
      allow read: if isAdmin();
    }
    
    // User carnival planning data in artifacts - user can access their own, admin can read all
    match /artifacts/{appId}/users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read: if isAdmin();
    }
    
    // Nested data under artifacts users
    match /artifacts/{appId}/users/{userId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read: if isAdmin();
    }
    
    // User root document - for analytics tracking
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read, write: if isAdmin();
    }
    
    // User profile, preferences, and nested data
    match /users/{userId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read, write: if isAdmin();
    }
    
    // Carnival Events - scraped data only accessible via Cloud Function (premium validation)
    // Direct reads are blocked; use getScrapedEvents Cloud Function instead
    // Carnival Events - scraped data only accessible via Cloud Function (premium validation)
    // Direct reads are blocked; use getScrapedEvents Cloud Function instead
    match /carnivalEvents/{carnivalId} {
      allow read: if false;
      allow write: if isAdmin();
    }

    // --- SQUAD MODE RULES ---
    match /squads/{squadId} {
      // Create: Any authenticated user can create a squad
      allow read: if request.auth != null && (
        resource.data.members.hasAny([request.auth.uid]) || 
        resource.data.leaderId == request.auth.uid
      );
      // Allow create by auth users
      allow create: if request.auth != null;
      
      // Allow update by auth users (needed for joining/adding self to members)
      allow update: if request.auth != null;
                          
      // Delete: Only the leader can delete the squad
      allow delete: if request.auth != null && request.auth.uid == resource.data.leaderId;

      // MESSAGES SUBCOLLECTION
      match /messages/{messageId} {
        // TEMPORARY DEBUG: Allow any auth user to read messages
        allow read, create: if request.auth != null;
      }
    }
  }
}
