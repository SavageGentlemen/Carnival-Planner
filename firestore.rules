rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && request.auth.token.email == 'djkrss1@gmail.com';
    }
    
    // PromoAds - readable by all (including unauthenticated for display), writable only by admin
    match /promoAds/{adId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Support requests - writable by all authenticated users, readable by admin
    match /support-requests/{requestId} {
      allow create: if request.auth != null;
      allow read, update, delete: if isAdmin();
    }
    
    // User activity tracking - any authenticated user can create, admin can read all
    match /user-activity/{activityId} {
      allow create: if request.auth != null;
      allow read: if isAdmin();
    }
    
    // User carnival planning data in artifacts - user can access their own, admin can read all
    match /artifacts/{appId}/users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read: if isAdmin();
    }
    
    // Nested data under artifacts users
    match /artifacts/{appId}/users/{userId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read: if isAdmin();
    }
    
    // User root document - for analytics tracking
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read, write: if isAdmin();
    }
    
    // User profile, preferences, and nested data
    match /users/{userId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read, write: if isAdmin();
    }
    
    // Carnival Events - scraped data only accessible via Cloud Function (premium validation)
    // Direct reads are blocked; use getScrapedEvents Cloud Function instead
    // Carnival Events - scraped data only accessible via Cloud Function (premium validation)
    // Direct reads are blocked; use getScrapedEvents Cloud Function instead
    match /carnivalEvents/{carnivalId} {
      allow read: if false;
      allow write: if isAdmin();
    }

    // --- SQUAD MODE RULES ---
    match /squads/{squadId} {
      // Create: Any authenticated user can create a squad
      // Allow read by any auth user (needed to lookup by code)
      allow read: if request.auth != null;
      
      // Allow create by auth users
      allow create: if request.auth != null;
      
      // Allow update by auth users (needed for joining/adding self to members)
      allow update: if request.auth != null;
                          
      // Delete: Only the leader can delete the squad
      allow delete: if request.auth != null && request.auth.uid == resource.data.leaderId;

      // MESSAGES SUBCOLLECTION
      match /messages/{messageId} {
        // Secure: Only members can read/write messages
        allow read, create: if request.auth != null && (
           request.auth.uid in get(/databases/$(database)/documents/squads/$(squadId)).data.members
        );
      }
    }
    
    // --- MASQUERADER PROFILES ---
    // Public profiles - readable if public OR by owner, writable only by owner
    match /userProfiles/{userId} {
      allow read: if resource.data.isPublic == true || 
                    (request.auth != null && request.auth.uid == userId);
      allow create, update: if request.auth != null && request.auth.uid == userId;
      allow delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // Username registry - for enforcing uniqueness
    match /usernames/{username} {
      allow read: if true;  // Anyone can check if username is taken
      allow create: if request.auth != null && 
                      request.resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && 
                      resource.data.userId == request.auth.uid;
    }
    
    // --- AFFILIATE/CREATOR PROGRAM ---
    match /affiliates/{affiliateId} {
      // Owner can read their own affiliate data
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      // Any authenticated user can apply (create)
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      // Only admin can approve/update
      allow update, delete: if isAdmin();
    }
    
    // Affiliate click tracking (subcollection)
    match /affiliates/{affiliateId}/clicks/{clickId} {
      allow create: if true;  // Allow anonymous click tracking
      allow read: if request.auth != null && 
                    request.auth.uid == get(/databases/$(database)/documents/affiliates/$(affiliateId)).data.userId;
    }
    
    // --- SOCA PASSPORT 2.0 ---
    
    // Passport Profiles - user can read/write their own, public profiles readable by all
    match /passportProfiles/{userId} {
      allow read: if resource.data.isPublic == true || 
                    (request.auth != null && request.auth.uid == userId);
      allow create, update: if request.auth != null && request.auth.uid == userId;
      allow delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // Passport Stamps - user can read their own, create via Cloud Function
    match /passportStamps/{stampId} {
      allow read: if request.auth != null && 
                    request.auth.uid == resource.data.userId;
      // Stamps are created via Cloud Function only
      allow create, update, delete: if false;
    }
    
    // Passport Check-ins - created via Cloud Function, user can read their own
    match /passportCheckins/{checkinId} {
      allow read: if request.auth != null && 
                    request.auth.uid == resource.data.userId;
      // Check-ins are created via Cloud Function only
      allow create, update, delete: if false;
    }
    
    // Passport Events - readable by authenticated users, managed by admin
    match /passportEvents/{eventId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    // Passport Achievements - definitions readable by all authenticated users
    match /passportAchievements/{achievementId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    // Passport Leaderboard - public read
    match /passportLeaderboard/{entryId} {
      allow read: if true;
      allow write: if false; // Updated via Cloud Function
    }
  }
}
